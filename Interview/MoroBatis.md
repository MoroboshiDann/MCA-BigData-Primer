# 框架中的反射和代理怎么体现的

首先，MyBatis框架可以让我们只给出Dao接口，而不用给出实现类就可以直接调用接口中的方法来操作数据库，这一点就是通过反射和代理来实现的。

通过Java提供的动态代理方式，我们可以实现一个MapperProxy类，实现InvocationHandler接口，重写invoke方法，在其中实现Dao接口方法的执行逻辑。然后，再通过Proxy#newInstance方法，为Dao接口创建代理类对象。这样，在调用Dao接口方法时，实际上是执行的invoke方法中的逻辑，然后在其中我们听过反射的方式来判断方法对应的SQL类型，执行对应的方法。

其次，还有返回结果。比如通过查询语句会将数据库对应记录返回给Java程序，此时我们就需要进行类型映射，创建对应的Java对象，并通过反射的方式将记录中的字段填充到对象对应的属性中去。

# 多边服务如何设计

MyBatis中一次数据库操作，涉及多个步骤，如判断SQL类型、调用SQL执行逻辑、准备SQL语句、参数填充、结果转换等。我们需要按照功能来将一次数据库操作划分开来，将代码解耦。于是就需要定义执行器、语言驱动、语句管理器、参数管理器等，而这些部分之间相互关联调用。我们将他们全部封装起来，外界只需要通过SqlSession来调用即可，而不需要关注内部的细节。

# 设计模式

创建型的：
- 工厂模式：SqlSessionFactory，通过工厂来创建对象，规范操作。
- 建造者模式：可以比较方便地创建对象并填充属性，链式调用。
- 单例模式：Configuration，整个程序只有一个Configuration对象，只有在解析XML文件时才会创建，因此能够保证单例。

结构型的：
- 适配器模式：如日志的适配器，现有的日志框架有很多，为了能够适配使用大部分框架，Mybatis定义了在其内部日志需要完成的动作，抽取到一个接口中，只需要对不同的日志框架给出实现类，即可直接使用该日志框架，而不需要作出修改。
- 代理模式：能够通过对象的替代品来控制程序对于原对象的访问，代理模式也是很多框架的核心，没有代理模式就没有各类框架。
- 装饰器模式：可以将对象封装进包含一些额外行为的封装对象中，从而为元对象绑定新的行为。对于Mybatis中的执行器，我们将大部分逻辑和一级缓存功能放在了SipmpleExcutor中，二级缓存又是在一级缓存的基础上实现的，所以系统会默认创建SimpleExcutor对象，然后判断是否开启二级缓存，如果是就将其在封装进一个二级缓存执行器中。

行为型：
- 模板模式：在使用执行器时，有很多共性逻辑，只有一小部分是需要根据传入参数特殊处理的，就可以将共性逻辑抽取到一个抽象类中，这样可以节约代码。且子类可以在不修改代码的情况下，改变具体的执行逻辑。
- 策略模式：比如对于返回值的处理，需要按照不同类型来获取不同的值，我们只需要定义一个接口，针对不同类型给出不同实现类，就可以避免大量判断。

# 缓存怎么实现的

一级缓存的生命周期是一个Session中，如果一个Session中发起了多次查询操作，就可以在其内部设定一个HashMap，用来缓存查询结果，Session关闭就清空缓存。如果，Session中发生了更新删除等修改操作，就需要清空缓存。

二级缓存的生命周期是是全局的，因为不同的Session也可能会操作同一个SQL语句，所以可以设置一个全局的缓存来减少查询量。当一次会话结束时，可以将一级缓存的内容刷新进二级缓存。这样下次执行相同SQL时就可以读取缓存。也可以为二级缓存设置缓存策略，如先进先出、LRU等。

# Mybatis Plugin怎么实现的

主要是通过Java的代理和拦截器来实现。我们定义拦截器接口和拦截器注解，注解用于标记触发拦截器的位置。然后，通过定义Plugin类来定义插件的具体功能，并通过代理来为拦截器创建代理对象。这样，在执行到对应位置时，会触发拦截器，执行代理对象中对应的逻辑。