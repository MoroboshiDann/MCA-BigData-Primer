# 一、计算机网络基础

## 1. 网络分层协议

ISO七层协议：物联网淑慧实用。物理层、数据链路层、网络层、传输层、表示层、应用层。

TCP./IP四层协议：网络接口层、网络层、传输层、应用层。

**复杂的系统需要分层，因为每一层都需要专注于一类事情。网络分层的原因也是一样，每一层只专注于做一类事情。**

- *各层之间相互独立**：各层之间相互独立，各层之间不需要关心其他层是如何实现的，只需要知道自己如何调用下层提供好的功能就可以了(可以简单理解为接口调用)**。这个和我们对开发时系统进行分层是一个道理。
- 提高了灵活性和可替换性**：每一层都可以使用最适合的技术来实现，你只需要保证你提供的功能以及暴露的接口的规则没有改变就行了。并且，每一层都可以根据需要进行修改或替换，而不会影响到整个网络的结构。**这个和我们平时开发系统的时候要求的高内聚、低耦合的原则也是可以对应上的。
- 大问题化小**：分层可以将复杂的网络问题分解为许多比较小的、界线比较清晰简单的小问题来处理和解决。这样使得复杂的计算机网络系统变得易于设计，实现和标准化。 **这个和我们平时开发的时候，一般会将系统功能分解，然后将复杂的问题分解为容易理解的更小的问题是相对应的，这些较小的问题具有更好的边界(目标和接口)定义。

## 2. 常见的协议

- HTTP：超文本传输协议，基于TCP。用来传输超文本和媒体内容。常用于web浏览器和web服务器之间传输信息。
- FTP：文件传输协议，基于TCP。用于在计算机之间传输文件的协议。
- ARP：用于根据IP地址获取机器MAC地址的协议。
- DNS：域名服务协议。用于将url域名转换为IP地址的协议。



# 二、HTTP

## 1. 从输入URL到页面展示都经过了什么步骤

从在浏览器搜索栏输入URL到页面渲染展示，主要经历了以下步骤：

- 浏览器通过DNS协议，获取域名对应的IP地址。
- 浏览器根据IP地址和端口号，向目标服务器发起TCP连接请求。
- TCP链接经过三次握手建立完成，在TCP链接上发送一个HTTP请求报文，请求获取网页内容。
- 服务器收到HTTP请求报文后，处理请求，并返回HTTP响应报文给客户端。
- 客户端浏览器收到HTTP响应报文后，解析报文中的代码，渲染网页结构和样式。并根据网页上的其他资源的URL，发起HTTP请求，直到网页内容全部显示完毕。
- 浏览器在不需要TCP链接通信时，可以主动关闭TCP，或等待服务端关闭。

## 2. HTTP状态码

| 状态码 | 类别                           | 原因短语                   |
| ------ | ------------------------------ | -------------------------- |
| 1XX    | Informational(信息性状态码)    | 接收的请求正在处理         |
| 2XX    | Success(成功状态码)            | 请求正常处理完毕           |
| 3XX    | Redirection(重定向状态码)      | 需要进行附加操作以完成请求 |
| 4XX    | Client Error(客户端错误状态码) | 服务器无法处理请求         |
| 5XX    | Server Error(服务端错误状态码) | 服务器处理请求出错         |

## 3. HTTP和HTTPS的区别

1. 端口号：HTTP默认是80端口，HTTPS默认是443端口
2. URL前缀不同：`http://`和`https://`
3. 安全性和资源消耗：HTTP协议运行在TCP之上，所有的报文都是明文传输，客户端和服务端都无法验明对方身份；HTTPS运行在SSL/TLS之上，SSL/TLS运行在TCP之上，传输报文经过加密。加密方式为对称加密，但对称加密的密钥用服务器的证书做了非对称加密。所以HTTP没有HTTPS安全性高，但是HTTPS消耗服务器资源较多。

## 4. HTTPS的SSL/TLS原理

### 对称加密

使用 SSL/TLS 进行通信的双方需要使用非对称加密方案来通信，但是非对称加密设计了较为复杂的数学算法，在实际通信过程中，计算的代价较高，效率太低，因此，HTTPS协议双方通信时采用的是对称加密，即只有一把密钥。对称加密具有**加解密速度快**，**性能高**的特点。

但是，对称加密需要双发持有一把密钥，因此需要将密钥通过网络传输。为了保证对称加密的密钥不被泄露，就需要对密钥进行非对称加密。

### 非对称加密

SSL/TLS的核心是非对称加密。非对称加密采用两个密钥：私钥和公钥。在通信时，私钥由解密者保管，公钥交给需要跟解密者通信的发送方保管。

非对称加密中，信息被私钥加密时只能由公钥解密，由公钥加密时只能由私钥解密。

服务器会生成公钥和私钥，并将公钥传输给客户端，私钥保留在服务器。

但是，直接传输也存在被人掉包的风险。于是就要通过第三方权威机构CA给机构颁发证书。服务器向CA申请证书，然后在证书上附上公钥，发送给客户端。客户端收到公钥时检查证书，就能知道这个公钥是否被掉包。

### 总结

客户端和服务端通信采用的是对称加密，但是在通信之前需要将密钥发送给对方。

于是，服务器先生成一堆公钥和私钥，并向CA申请证书，将公钥附在证书上，传输给客户端。

客户端检查证书，收到公钥，对对称加密的密钥进行加密，发送给服务端。服务端使用私钥对密钥解密。

这样双方就获得了对称加密的密钥，可以开始通信。



## 5. HTTP是不保存状态的协议，如何保存用户状态

HTTP 是一种不保存状态，即无状态(stateless)协议。也就是说 HTTP 协议自身不对请求和响应之间的通信状态进行保存。

一般通过Session来保存用户状态。Session 的主要作用就是通过服务端记录用户的状态。服务端给特定的用户创建特定的 Session 之后就可以标识这个用户并且跟踪这个用户了(一般情况下，服务器会在一定时间内保存这个 Session，过了时间限制，就会销毁这个 Session)。

那么我们如何实现 Session 跟踪呢？大部分情况下，我们都是通过在 Cookie 中附加一个 Session ID 来方式来跟踪。

## 6. URI和URL的区别

URI(Uniform Resource Identifier)统一资源标识符，可以唯一标识一个资源。

URL(Uniform Resource Locator)统一资源定位符，可以提供资源的路径。是一种具体的URI，不仅标识除了唯一的资源，还给出了如何定位该资源。



# 三、WebSocket

## 1. 什么是WebSocket

WebSocket 是一种基于 TCP 连接的全双工通信协议，即客户端和服务器可以同时发送和接收数据。

WebSocket 协议本质上是应用层的协议，用于弥补 HTTP 协议在持久通信能力上的不足。客户端和服务器仅需一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。

WebSocket 的工作过程可以分为以下几个步骤：

1. 客户端向服务器发送一个 HTTP 请求，请求头中包含 `Upgrade: websocket` 和 `Sec-WebSocket-Key` 等字段，表示要求升级协议为 WebSocket；
2. 服务器收到这个请求后，会进行升级协议的操作，如果支持 WebSocket，它将回复一个 HTTP 101 状态码，响应头中包含 ，`Connection: Upgrade`和 `Sec-WebSocket-Accept: xxx` 等字段、表示成功升级到 WebSocket 协议。
3. 客户端和服务器之间建立了一个 WebSocket 连接，可以进行双向的数据传输。数据以帧(frames)的形式进行传送，WebSocket 的每条消息可能会被切分成多个数据帧(最小单位)。发送端会将消息切割成多个帧发送给接收端，接收端接收消息帧，并将关联的帧重新组装成完整的消息。
4. 客户端或服务器可以主动发送一个关闭帧，表示要断开连接。另一方收到后，也会回复一个关闭帧，然后双方关闭 TCP 连接。

## 2. WebSocket和HTTP的区别

- 双工/单工：WebSocket 是一种双向实时通信协议，而 HTTP 是一种单向通信协议。并且，HTTP 协议下的通信只能由客户端发起，服务器无法主动通知客户端。
- 协议前缀：WebSocket 使用 ws:// 或 wss://(使用 SSL/TLS 加密后的协议，类似于 HTTP 和 HTTPS 的关系) 作为协议前缀，HTTP 使用 http:// 或 https:// 作为协议前缀。
- 是否支持扩展：WebSocket 可以支持扩展，用户可以扩展协议，实现部分自定义的子协议，如支持压缩、加密等。
- 是否轻量级：WebSocket 通信数据格式比较轻量，用于协议控制的数据包头部相对较小，网络开销小，而 HTTP 通信每次都要携带完整的头部，网络开销较大(HTTP/2.0 使用二进制帧进行数据传输，还支持头部压缩，减少了网络开销)。

# 四、DNS

## 1. DNS服务器有哪些

- 根服务器
- 顶级域名服务器：`com`, `cn`, `edu`等
- 权威域名服务器：在因特网上具有公共可访问主机的每个组织机构必须提供公共可访问的 DNS 记录，这些记录将这些主机的名字映射为 IP 地址。如`www.qq.com`，权威域名服务器解析的就是`qq`部分。
- 本地域名服务器：当主机发出 DNS 请求时，该请求被发往本地 DNS 服务器，它起着代理的作用，并将该请求转发到 DNS 层次结构中。

## 2. DNS劫持

DNS 劫持是一种网络攻击，它通过修改 DNS 服务器的解析结果，使用户访问的域名指向错误的 IP 地址，从而导致用户无法访问正常的网站，或者被引导到恶意的网站。DNS 劫持有时也被称为 DNS 重定向、DNS 欺骗或 DNS 污染。



# 五、TCP&UDP

## 1. TCP和UDP的区别

- 是否面向连接：TCP面向连接，传输数据之前需要建立连接；UDP面向无连接，不需要建立连接即可传输数据。
- 是否可靠传输：TCP为可靠传输，在传输数据时有确认、重传、窗口、阻塞机制。TCP传输的报文无差错、不丢失、不重复且按序到达。UDP非可靠传输，报文不保证数据正确传达，不保证顺序。
- 是否有状态：TCP传输有状态，会记录数据是否发出、是否被接收。UDP无状态，只管发送。
- TCP面向字节，UDP面向报文。

**UDP 一般用于即时通信**，比如：语音、 视频、直播等等。这些场景对传输数据的准确性要求不是特别高，比如你看视频即使少个一两帧，实际给人的感觉区别也不大。

**TCP 用于对传输准确性要求特别高的场景**，比如文件传输、发送和接收邮件、远程登录等等。

## 2. 三次握手和四次握手

### 三次握手

三次握手用于建立TCP链接。由客户端发起连接建立请求，具体过程如下：

1. 客户端发送带有`SYN`标志的数据包，然后客户端进入`SYN_SEND`状态(同步已发送)。
2. 服务器接收到客户端的数据包后，发送带有`SYN + ACK`标志的数据包(同步+确认)，服务器进入`SYN_RECV`状态(同步已接收)。
3. 客户端接收到服务器的数据包后，发送带有`ACK`标志的数据包，并且可以开始携带数据。客户端和服务器都进入`ESTABLISHED`状态。

> 为什么一定要三次握手，而不是两次。
>
> 为了防止造成服务器资源的浪费。假设只有两次握手，客户端发送第一次握手后，服务器就会为其分配资源，如果此时客户端下线，且未发起断开连接的请求，服务器端资源就会被一直占用。且可以通过恶意创建链接的方式快速将服务器资源消耗殆尽。
>
> 另外，如果客户端已经和服务器传送完数据，断开了连接。此时先前某次建立连接的请求由于网络拥塞，才到达服务端，服务端就会再次为其分配资源，导致资源的分配。

### 四次握手

四次握手用于释放TCP链接。双方都可以发起，具体过程如下(以客户端发起释放请求为例)：

1. 客户端发送带有`FIN`标志的数据包，用来关闭客户端到服务端的数据传送。客户端进入到`FIN_WAIT`状态。
2. 服务器接收到客户端发来的数据包，服务端发送一个带有`ACK`标志的数据包，因为此时服务端可能还有要发送的数据。服务器进入`CLOSE_WAIT`状态。客户端接收到后，进入`FIN_WAIT2`状态。
3. 服务器发送带有`FIN`标志的数据包，进入`LAST_ACK`状态。
4. 客户端接收到服务器的数据包，发送带有`ACK`标志的数据包，进入`TIME_WAIT`状态。服务端接收到后，进入到`CLOSE`状态。如果客户端等待2MSL时间后没有收到服务端的回复，证明服务端已经关闭，客户端也关闭。

> 为什么要有四次握手，而不是三次？
>
> 首先，TCP是全双工通信，可以双向传输数据，任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了 TCP 连接。
>
> 其次，第四次握手之后的`TIME_WAIT`状态也是必须的，
>
> 为什么第二次和第三次握手不能合并？
>
> 因为，此时被动方可能还有未发送完的数据。

## 3. TCP如何保证传输的可靠性

1. **基于数据块传输**：应用数据被分割成 TCP 认为最适合发送的数据块，再传输给网络层，数据块被称为报文段或段。
2. **对失序数据包重新排序以及去重**：TCP 为了保证不发生丢包，就给每个包一个序列号，有了序列号能够将接收到的数据根据序列号排序，并且去掉重复序列号的数据就可以实现数据包去重。
3. **校验和** : TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
4. **重传机制** : 在数据包丢失或延迟的情况下，重新发送数据包，直到收到对方的确认应答(ACK)。TCP 重传机制主要有：基于计时器的重传(也就是超时重传)、快速重传(基于接收端的反馈信息来引发重传)、SACK(在快速重传的基础上，返回最近收到的报文段的序列号范围，这样客户端就知道，哪些数据包已经到达服务器了)、D-SACK(重复 SACK，在 SACK 的基础上，额外携带信息，告知发送方有哪些数据包自己重复接收了)。
5. **流量控制** : TCP 连接的每一方都有固定大小的缓冲空间，TCP 的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议(TCP 利用滑动窗口实现流量控制)。
6. **拥塞控制** : 当网络拥塞时，减少数据的发送。TCP 在发送数据的时候，需要考虑两个因素：一是接收方的接收能力，二是网络的拥塞程度。接收方的接收能力由滑动窗口表示，表示接收方还有多少缓冲区可以用来接收数据。网络的拥塞程度由拥塞窗口表示，它是发送方根据网络状况自己维护的一个值，表示发送方认为可以在网络中传输的数据量。发送方发送数据的大小是滑动窗口和拥塞窗口的最小值，这样可以保证发送方既不会超过接收方的接收能力，也不会造成网络的过度拥塞。

## 4. TCP如何实现流量控制

滑动窗口，发送方根据接收方的情况来调整发送窗口的大小。

## 5. TCP如何实现拥塞控制

TCP发送方维护一个拥塞窗口的变量，根据网络状态来调整拥塞窗口的大小。

![](../img/tcp-congestion-control.png)

- **慢开始：** 慢开始算法的思路是当主机开始发送数据时，如果立即把大量数据字节注入到网络，那么可能会引起网络阻塞，因为现在还不知道网络的符合情况。经验表明，较好的方法是先探测一下，即由小到大逐渐增大发送窗口，也就是由小到大逐渐增大拥塞窗口数值。cwnd 初始值为 1，每经过一个传播轮次，cwnd 加倍。
- **拥塞避免：** 拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢增大，即每经过一个往返时间 RTT 就把发送方的 cwnd 加 1.
- **快重传与快恢复：** 在 TCP/IP 中，快速重传和恢复（fast retransmit and recovery，FRR）是一种拥塞控制算法，它能快速恢复丢失的数据包。没有 FRR，如果数据包丢失了，TCP 将会使用定时器来要求传输暂停。在暂停的这段时间内，没有新的或复制的数据包被发送。有了 FRR，如果接收机接收到一个不按顺序的数据段，它会立即给发送机发送一个重复确认。如果发送机接收到三个重复确认，它会假定确认件指出的数据段丢失了，并立即重传这些丢失的数据段。有了 FRR，就不会因为重传时要求的暂停被耽误。 　当有单独的数据包丢失时，快速重传和恢复（FRR）能最有效地工作。当有多个数据信息包在某一段很短的时间内丢失时，它则不能很有效地工作。